name: workerd

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  wasm-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-bindgen CLI
        run: cargo install wasm-bindgen-cli --version 0.2.92

      - name: Build worker example
        run: cargo build --example worker --release --target wasm32-unknown-unknown

      - name: Generate bindings
        run: |
          wasm-bindgen --target web --out-dir target/workerd target/wasm32-unknown-unknown/release/examples/worker.wasm
          cp ci/workerd/worker.mjs target/workerd/worker.mjs

      - name: Download workerd
        run: |
          curl -L https://github.com/cloudflare/workerd/releases/latest/download/workerd-linux-x64 -o workerd
          chmod +x workerd

      - name: Create workerd config
        run: |
          cat <<'EOF' > target/workerd/config.capnp
          using Workerd = import "/workerd/workerd.capnp";

          const config :Workerd.Config = (
            services = [
              ( name = "worker", worker = (
                  modules = [
                      (name = "worker", esModule = embed "worker.mjs"),
                      (name = "bindings", esModule = embed "worker.js"),
                      (name = "wasm", wasmModule = embed "worker_bg.wasm"),
                  ],
              )),
            ],
            sockets = [
              ( name = "http", address = "127.0.0.1:8787", http = (), service = "worker"),
            ],
          );
          EOF

      - name: Launch workerd
        run: |
          ./workerd serve target/workerd/config.capnp &
          echo $! > workerd.pid
          sleep 5

      - name: Exercise worker
        run: |
          curl --retry 5 --retry-connrefused --retry-delay 1 http://127.0.0.1:8787/ | grep "Hello from Skyzen!"

      - name: Shutdown workerd
        if: always()
        run: |
          if [ -f workerd.pid ]; then
            kill $(cat workerd.pid)
          fi
