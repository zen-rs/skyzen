name: workerd

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  wasm-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-bindgen CLI
        run: cargo install wasm-bindgen-cli --version 0.2.100

      - name: Build worker example
        run: cargo build --example worker --release --target wasm32-unknown-unknown --no-default-features --features json,form

      - name: Generate bindings
        run: |
          wasm-bindgen --target web --out-dir target/workerd target/wasm32-unknown-unknown/release/examples/worker.wasm
          cp ci/workerd/worker.mjs target/workerd/worker.mjs
          cp ci/workerd/wrangler.toml target/workerd/wrangler.toml

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Launch wrangler dev
        run: |
          cd target/workerd
          wrangler dev --local --config wrangler.toml --port 8787 &
          echo $! > ../../wrangler.pid
          sleep 5

      - name: Exercise worker
        run: |
          curl --retry 5 --retry-connrefused --retry-delay 1 http://127.0.0.1:8787/ | grep "Hello from Skyzen!"

      - name: Shutdown wrangler
        if: always()
        run: |
          if [ -f wrangler.pid ]; then
            kill $(cat wrangler.pid)
          fi
